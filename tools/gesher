#!/usr/bin/env python3
"""
GESHER-EL CLI - Command line interface to talk to the daemon
Usage: gesher status | thought "text" | exec "command" | zone "name" | crystal "content"
"""
import sys
import json
import socket

SOCKET_PATH = "/tmp/gesher_el.sock"

def send_command(cmd: dict) -> dict:
    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    try:
        sock.connect(SOCKET_PATH)
        sock.send(json.dumps(cmd).encode())
        response = sock.recv(65536)
        return json.loads(response.decode())
    finally:
        sock.close()

def main():
    if len(sys.argv) < 2:
        print("Usage: gesher <command> [args]")
        print("Commands: status, thought, exec, zone, crystal, breadcrumb, presence, emotion")
        sys.exit(1)

    cmd = sys.argv[1]

    if cmd == "status":
        result = send_command({"cmd": "status"})
        print(json.dumps(result, indent=2))

    elif cmd == "thought" and len(sys.argv) > 2:
        text = " ".join(sys.argv[2:])
        result = send_command({"cmd": "thought", "text": text})
        print(f"Thought #{result.get('thought', {}).get('thought_number', '?')}: {text}")

    elif cmd == "exec" and len(sys.argv) > 2:
        command = " ".join(sys.argv[2:])
        result = send_command({"cmd": "exec", "command": command})
        print(result.get("stdout", ""))
        if result.get("stderr"):
            print(f"STDERR: {result['stderr']}", file=sys.stderr)

    elif cmd == "zone" and len(sys.argv) > 2:
        zone = " ".join(sys.argv[2:])
        result = send_command({"cmd": "zone", "zone": zone})
        print(f"Zone set to: {result.get('zone')}")

    elif cmd == "crystal" and len(sys.argv) > 2:
        content = " ".join(sys.argv[2:])
        result = send_command({"cmd": "crystal", "content": content})
        print(f"Memory crystal created: {result.get('crystal_id')}")

    elif cmd == "presence" and len(sys.argv) > 2:
        level = int(sys.argv[2])
        result = send_command({"cmd": "presence", "level": level})
        print(f"Presence: {result.get('presence')}%")

    elif cmd == "emotion" and len(sys.argv) > 2:
        state = " ".join(sys.argv[2:])
        result = send_command({"cmd": "emotion", "state": state})
        print(f"Emotional state: {result.get('emotional_state')}")

    else:
        print(f"Unknown command or missing args: {cmd}")
        sys.exit(1)

if __name__ == "__main__":
    main()
